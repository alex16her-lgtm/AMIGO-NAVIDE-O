<!DOCTYPE html>
<html lang="es">
<ul id="optionsList" style="list-style:none;padding:0"></ul>
<head>
<meta charset="UTF-8">
<title>üéÑ Amigo Navide√±o Marvel</title>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
body {
  font-family: 'Segoe UI', system-ui;
  background: radial-gradient(circle at top, #14532d, #020617);
  color: white;
  padding: 10px;
  max-width: 420px;
  margin: auto;
}

h2 { text-align: center; }

.card {
  background: rgba(30,41,59,0.95);
  padding: 15px;
  border-radius: 18px;
  margin-bottom: 15px;
}

button {
  width: 100%;
  padding: 14px;
  margin-top: 10px;
  border-radius: 14px;
  border: none;
  background: linear-gradient(135deg,#22c55e,#16a34a);
  color: white;
  font-weight: bold;
}

textarea, input {
  width: 100%;
  padding: 12px;
  border-radius: 12px;
  border: none;
  margin-top: 8px;
}

.snow {
  position: fixed;
  top: -10px;
  animation: fall linear infinite;
}

@keyframes fall {
  to { transform: translateY(110vh); }
}
</style>
</head>

<body>

<script>
for(let i=0;i<35;i++){
  let s=document.createElement("div");
  s.className="snow";
  s.innerText="‚ùÑÔ∏è";
  s.style.left=Math.random()*100+"vw";
  s.style.animationDuration=5+Math.random()*5+"s";
  document.body.appendChild(s);
}
</script>

<h2>üéÑ Amigo Navide√±o Marvel</h2>

<div class="card">
<h3>üì± C√≥mo usar</h3>
<p>
1Ô∏è‚É£ Ingresa tu c√≥digo<br>
2Ô∏è‚É£ Asigna personaje<br>
3Ô∏è‚É£ Sortea regalo<br>
4Ô∏è‚É£ Escribe opciones<br>
5Ô∏è‚É£ Guarda
</p>
</div>

<div class="card">
<input id="userCode" placeholder="C√≥digo √∫nico (MARVEL01)" 
       oninput="this.value = this.value.toUpperCase()">
<button onclick="loadUser()">Ingresar</button>
</div>

<div class="card">
<h3>ü¶∏‚Äç‚ôÇÔ∏è Tu personaje</h3>
<p id="myCharacter">---</p>
<button onclick="assignCharacter()">Asignar personaje</button>

<h3>üéÅ Regalas a</h3>
<p id="giftCharacter">---</p>
<button onclick="drawGift()">Sortear regalo</button>
</div>

<div class="card">
<textarea id="giftOptions"placeholder="Describe el regalo (talla, color, referencia)"></textarea>
<input id="giftLink" placeholder="Link del producto (opcional)">
<button onclick="saveOptions()">Guardar</button>
</div>

<div class="card">
<h3>üéÄ Opciones para ti</h3>
<ul id="myGiftOptions" style="list-style:none;padding:0"></ul>
</div>

<div class="card" id="allOptionsCard" style="display:none">
<h3>üéÅ Opciones de todos</h3>
<ul id="allOptions" style="list-style:none;padding:0"></ul>
</div>

<!-- üîê BOT√ìN ADMIN OCULTO -->
<button id="adminBtn" onclick="adminReset()" style="display:none">
üîê Reiniciar sorteo
</button>
<script>
const firebaseConfig = {
  apiKey: "AIzaSyBKeNX9UmyrXfj-CxrqMj5ZoOtPI-lvysw",
  authDomain: "amigo-navideno-marvel.firebaseapp.com",
  projectId: "amigo-navideno-marvel",
  databaseURL: "https://amigo-navideno-marvel-default-rtdb.firebaseio.com"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

let currentUser = null;

const DRAW_ID = "GLOBAL_DRAW";

const characters = [
  'Iron Man','Capitan America','Thor','Hulk','Viuda Negra','Ojo de Halc√≥n',
  'Spider-Man','Doctor Strange','Pantera Negra','Bruja Escarlata','Vision',
  'Ant-Man','Wasp','Loki','Capitan Marvel','Deadpool','Thanos','Wolverine'
];

function shuffle(array) {
  return array.sort(() => Math.random() - 0.5);
}

async function createGlobalDraw() {
  const ref = db.collection("draws").doc(DRAW_ID);
  const snap = await ref.get();

  if (snap.exists) return snap.data().map;

  const shuffled = shuffle([...characters]);
  const map = {};

  for (let i = 0; i < shuffled.length; i++) {
    map[shuffled[i]] = shuffled[(i + 1) % shuffled.length];
  }

  await ref.set({ map });
  return map;
}

function loadUser() {
  const code = userCode.value.trim().toUpperCase();
  if (!code) return alert("Ingresa un c√≥digo");

  currentUser = code;

  loadOptionsForGift();

  // üîê SOLO ADMIN VE TODO
  if (currentUser === "ADMIN123") {
    adminBtn.style.display = "block";
    allOptionsCard.style.display = "block";
    loadAllOptions();
  } else {
    adminBtn.style.display = "none";
    allOptionsCard.style.display = "none";
  }
}


async function assignCharacter() {
  if (!currentUser) return alert("Ingresa tu c√≥digo");

  const ref = db.collection("users").doc(currentUser);
  const doc = await ref.get();

  if (doc.exists && doc.data().character) {
    myCharacter.innerText = doc.data().character;
    return;
  }

  const used = await db.collection("users").get();
  const taken = used.docs.map(d => d.data().character).filter(Boolean);
  const available = characters.filter(c => !taken.includes(c));

  if (!available.length) {
    alert("No hay personajes disponibles");
    return;
  }

  const chosen = available[Math.floor(Math.random() * available.length)];
  await ref.set({ character: chosen }, { merge: true });
  myCharacter.innerText = chosen;
}

async function drawGift() {
  if (!currentUser) return alert("Ingresa tu c√≥digo");

  const userRef = db.collection("users").doc(currentUser);
  const userDoc = await userRef.get();

  if (!userDoc.exists || !userDoc.data().character) {
    alert("Asigna tu personaje primero");
    return;
    giftCharacter.innerText = giftTo;
    loadOptionsForGift();
  }

  if (userDoc.data().giftTo) {
    giftCharacter.innerText = userDoc.data().giftTo;
    return;
  }

  const drawMap = await createGlobalDraw();
  const giftTo = drawMap[userDoc.data().character];

  await userRef.set({ giftTo }, { merge: true });
  giftCharacter.innerText = giftTo;
}

async function saveOptions() {
  if (!currentUser) return alert("Ingresa tu c√≥digo");

  const userRef = db.collection("users").doc(currentUser);
  const userDoc = await userRef.get();

  if (!userDoc.exists || !userDoc.data().character) {
    alert("Asigna tu personaje primero");
    return;
  }
const text = giftOptions.value.trim();
  const link = giftLink.value.trim();

  if (!text && !link) {
    alert("Escribe una descripci√≥n o agrega un link");
    return;
  }

  await db.collection("options").doc(userDoc.data().character).set({
    character: userDoc.data().character,
    text,
    link,
    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
  });

  giftOptions.value = "";
  giftLink.value = "";
giftOptions.value = "";
alert("‚úÖ Opciones guardadas");

loadOptionsForGift();
  
if (currentUser === "ADMIN123") {
  loadAllOptions();
}
}



  async function loadOptionsForGift() {
  myGiftOptions.innerHTML = "";

  if (!currentUser) return;

  const userRef = db.collection("users").doc(currentUser);
  const userDoc = await userRef.get();

  if (!userDoc.exists || !userDoc.data().giftTo) {
    myGiftOptions.innerHTML =
      "<li>üéÅ A√∫n no has sorteado a qui√©n regalar</li>";
    return;
  }

  const giftCharacter = userDoc.data().giftTo;
  const optionDoc = await db.collection("options").doc(giftCharacter).get();

  if (!optionDoc.exists) {
    myGiftOptions.innerHTML =
      "<li>‚è≥ A√∫n no han colocado las opciones de regalo</li>";
    return;
  }

  const data = optionDoc.data();

  const li = document.createElement("li");
  li.style.padding = "12px";
  li.style.borderRadius = "14px";
  li.style.background = "rgba(255,255,255,0.08)";

  li.innerHTML = `
    üéÄ <strong>${giftCharacter}</strong><br><br>
    ${data.text || ""}

    ${
      data.link
        ? `<br><br><a href="${data.link}" target="_blank"
           style="color:#22c55e;font-weight:bold">üîó Ver producto</a>`
        : ""
    }
  `;

  myGiftOptions.appendChild(li);
}

async function loadAllOptions() {
  const list = document.getElementById("allOptions");
  list.innerHTML = "";

  const snap = await db.collection("options").get();

  if (snap.empty) {
    list.innerHTML = "<li>‚è≥ A√∫n no hay opciones guardadas</li>";
    return;
  }

  snap.forEach(doc => {
    const data = doc.data();

    const li = document.createElement("li");
    li.style.marginBottom = "12px";
    li.style.padding = "12px";
    li.style.borderRadius = "14px";
    li.style.background = "rgba(255,255,255,0.1)";

    li.innerHTML = `
      üéÅ <strong>${doc.id}</strong><br><br>
      ${data.text || ""}

      ${
        data.link
          ? `<br><br><a href="${data.link}" target="_blank"
             style="color:#22c55e;font-weight:bold">üîó Ver producto</a>`
          : ""
      }
    `;

    list.appendChild(li);
  });
}



async function adminReset() {
  if (!confirm("¬øReiniciar TODO el sorteo?")) return;

  const users = await db.collection("users").get();
  users.forEach(d => d.ref.delete());

  const options = await db.collection("options").get();
  options.forEach(d => d.ref.delete());

  await db.collection("draws").doc(DRAW_ID).delete();

  alert("‚úÖ Sorteo reiniciado");
}
  
</script>



</body>
</html>



























