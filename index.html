<!DOCTYPE html>
<html lang="es">
<ul id="optionsList" style="list-style:none;padding:0"></ul>
<head>
<meta charset="UTF-8">
<title>ğŸ„ Amigo NavideÃ±o Marvel</title>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
body {
  font-family: 'Segoe UI', system-ui;
  background: radial-gradient(circle at top, #14532d, #020617);
  color: white;
  padding: 10px;
  max-width: 420px;
  margin: auto;
}

h2 { text-align: center; }

.card {
  background: rgba(30,41,59,0.95);
  padding: 15px;
  border-radius: 18px;
  margin-bottom: 15px;
}

button {
  width: 100%;
  padding: 14px;
  margin-top: 10px;
  border-radius: 14px;
  border: none;
  background: linear-gradient(135deg,#22c55e,#16a34a);
  color: white;
  font-weight: bold;
}

textarea, input {
  width: 100%;
  padding: 12px;
  border-radius: 12px;
  border: none;
  margin-top: 8px;
}

.snow {
  position: fixed;
  top: -10px;
  animation: fall linear infinite;
}

@keyframes fall {
  to { transform: translateY(110vh); }
}
</style>
</head>

<body>

<script>
for(let i=0;i<35;i++){
  let s=document.createElement("div");
  s.className="snow";
  s.innerText="â„ï¸";
  s.style.left=Math.random()*100+"vw";
  s.style.animationDuration=5+Math.random()*5+"s";
  document.body.appendChild(s);
}
</script>

<h2>ğŸ„ Amigo NavideÃ±o Marvel</h2>

<div class="card">
<h3>ğŸ“± CÃ³mo usar</h3>
<p>
1ï¸âƒ£ Ingresa tu cÃ³digo<br>
2ï¸âƒ£ Asigna personaje<br>
3ï¸âƒ£ Sortea regalo<br>
4ï¸âƒ£ Escribe opciones<br>
5ï¸âƒ£ Guarda
</p>
</div>

<div class="card">
<input id="userCode" placeholder="CÃ³digo Ãºnico (MARVEL01)" 
       oninput="this.value = this.value.toUpperCase()">
<button onclick="loadUser()">Ingresar</button>
</div>

<div class="card">
<h3>ğŸ¦¸â€â™‚ï¸ Tu personaje</h3>
<p id="myCharacter">---</p>
<button onclick="assignCharacter()">Asignar personaje</button>

<h3>ğŸ Regalas a</h3>
<p id="giftCharacter">---</p>
<button onclick="drawGift()">Sortear regalo</button>
</div>

<div class="card">
<textarea id="giftOptions"placeholder="Describe el regalo (talla, color, referencia)"></textarea>
<input id="giftLink" placeholder="Link del producto (opcional)">
<button onclick="saveOptions()">Guardar</button>
</div>

<div class="card">
<h3>ğŸ€ Opciones para ti</h3>
<ul id="myGiftOptions" style="list-style:none;padding:0"></ul>
</div>

<div class="card" id="allOptionsCard" style="display:none">
<h3>ğŸ Opciones de todos</h3>
<ul id="allOptions" style="list-style:none;padding:0"></ul>
</div>

<!-- ğŸ” BOTÃ“N ADMIN OCULTO -->
<button id="adminBtn" onclick="adminReset()" style="display:none">
ğŸ” Reiniciar sorteo
</button>
<script>
const firebaseConfig = {
  apiKey: "AIzaSyBKeNX9UmyrXfj-CxrqMj5ZoOtPI-lvysw",
  authDomain: "amigo-navideno-marvel.firebaseapp.com",
  projectId: "amigo-navideno-marvel",
  databaseURL: "https://amigo-navideno-marvel-default-rtdb.firebaseio.com"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

let currentUser = null;

const DRAW_ID = "GLOBAL_DRAW";

const characters = [
  'Iron Man','Capitan America','Thor','Hulk','Viuda Negra','Ojo de HalcÃ³n',
  'Spider-Man','Doctor Strange','Pantera Negra','Bruja Escarlata','Vision',
  'Ant-Man','Wasp','Loki','Capitan Marvel','Deadpool','Thanos','Wolverine'
];

function shuffle(array) {
  return array.sort(() => Math.random() - 0.5);
}

async function createGlobalDraw() {
  const ref = db.collection("draws").doc(DRAW_ID);
  const snap = await ref.get();

  if (snap.exists) return snap.data().map;

  const shuffled = shuffle([...characters]);
  const map = {};

  for (let i = 0; i < shuffled.length; i++) {
    map[shuffled[i]] = shuffled[(i + 1) % shuffled.length];
  }

  await ref.set({ map });
  return map;
}

function loadUser() {
  const code = userCode.value.trim().toUpperCase();
  if (!code) return alert("Ingresa un cÃ³digo");

  currentUser = code;

  loadOptionsForGift();

  // ğŸ” SOLO ADMIN VE TODO
  if (currentUser === "ADMIN123") {
    adminBtn.style.display = "block";
    allOptionsCard.style.display = "block";
    loadAllOptions();
  } else {
    adminBtn.style.display = "none";
    allOptionsCard.style.display = "none";
  }
}


async function assignCharacter() {
  if (!currentUser) return alert("Ingresa tu cÃ³digo");

  const ref = db.collection("users").doc(currentUser);
  const doc = await ref.get();

  if (doc.exists && doc.data().character) {
    myCharacter.innerText = doc.data().character;
    return;
  }

  const used = await db.collection("users").get();
  const taken = used.docs.map(d => d.data().character).filter(Boolean);
  const available = characters.filter(c => !taken.includes(c));

  if (!available.length) {
    alert("No hay personajes disponibles");
    return;
  }

  const chosen = available[Math.floor(Math.random() * available.length)];
  await ref.set({ character: chosen }, { merge: true });
  myCharacter.innerText = chosen;
}

async function drawGift() {
  if (!currentUser) return alert("Ingresa tu cÃ³digo");

  const userRef = db.collection("users").doc(currentUser);
  const userDoc = await userRef.get();

  if (!userDoc.exists || !userDoc.data().character) {
    alert("Asigna tu personaje primero");
    return;
    giftCharacter.innerText = giftTo;
    loadOptionsForGift();
  }

  if (userDoc.data().giftTo) {
    giftCharacter.innerText = userDoc.data().giftTo;
    return;
  }

  const drawMap = await createGlobalDraw();
  const giftTo = drawMap[userDoc.data().character];

  await userRef.set({ giftTo }, { merge: true });
  giftCharacter.innerText = giftTo;
}

async function saveOptions() {
  if (!currentUser) return alert("Ingresa tu cÃ³digo");

  const userRef = db.collection("users").doc(currentUser);
  const userDoc = await userRef.get();

  if (!userDoc.exists || !userDoc.data().character) {
    alert("Asigna tu personaje primero");
    return;
  }
const text = giftOptions.value.trim();
  const link = giftLink.value.trim();

  if (!text && !link) {
    alert("Escribe una descripciÃ³n o agrega un link");
    return;
  }

  await db.collection("options").doc(userDoc.data().character).set({
    character: userDoc.data().character,
    text,
    link,
    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
  });

  giftOptions.value = "";
  giftLink.value = "";
giftOptions.value = "";
alert("âœ… Opciones guardadas");

loadOptionsForGift();
  
if (currentUser === "ADMIN123") {
  loadAllOptions();
}
}


async function loadData() {
  optionsList.innerHTML = "";
  const snap = await db.collection("options").get();
  snap.forEach(d => {
    const li = document.createElement("li");
    li.innerText = d.data().text;
    optionsList.appendChild(li);
  });
}
  async function loadOptionsForGift() {
  myGiftOptions.innerHTML = "";

  const userRef = db.collection("users").doc(currentUser);
  const userDoc = await userRef.get();

  if (!userDoc.exists || !userDoc.data().giftTo) {
    myGiftOptions.innerHTML = "<li>ğŸ AÃºn no has sorteado a quiÃ©n regalar</li>";
    return;
  }

  const giftCharacter = userDoc.data().giftTo;
  const optionDoc = await db.collection("options").doc(giftCharacter).get();

  if (!optionDoc.exists) {
    myGiftOptions.innerHTML =
      "<li>â³ AÃºn no han colocado las opciones de regalo</li>";
    return;
  }
  myGiftOptions.innerHTML = `
    <li>
      ğŸ€ <strong>${giftCharacter}</strong><br>
      ${optionDoc.data().text}
    </li>
  `;
  const data = optionDoc.data();

  const li = document.createElement("li");
  li.style.padding = "12px";
  li.style.borderRadius = "14px";
  li.style.background = "rgba(255,255,255,0.08)";

  li.innerHTML = `
  <li>
    ğŸ€ <strong>${giftCharacter}</strong><br><br>
    ${data.text || ""}

    ${data.link 
      ? `<br><a href="${data.link}" target="_blank" style="color:#22c55e;font-weight:bold">ğŸ”— Ver producto</a>` 
      : ""
    }
    </li>
  `;

  optionsList.appendChild(li);
}
async function loadAllOptions() {
  const list = document.getElementById("allOptions");
  list.innerHTML = "";

  const snap = await db.collection("options").get();

  if (snap.empty) {
    const li = document.createElement("li");
    li.innerText = "â³ AÃºn no hay opciones guardadas";
    list.appendChild(li);
    return;
  }

  snap.forEach(doc => {
    const li = document.createElement("li");
    li.style.marginBottom = "12px";
    li.style.padding = "10px";
    li.style.borderRadius = "12px";
    li.style.background = "rgba(255,255,255,0.08)";

    li.innerHTML = `
      ğŸ€ <strong>${doc.id}</strong><br>
      ${doc.data().text}
    `;

    list.appendChild(li);
  });
}
async function loadAllOptionsAdmin() {
  optionsList.innerHTML = "";

  const snap = await db.collection("options").get();

  snap.forEach(doc => {
    const data = doc.data();
    const li = document.createElement("li");

    li.style.padding = "12px";
    li.style.borderRadius = "14px";
    li.style.background = "rgba(255,255,255,0.12)";
    li.style.marginBottom = "10px";

    li.innerHTML = `
      ğŸ <strong>${doc.id}</strong><br>
      ${data.text || ""}

      ${data.link 
        ? `<br><a href="${data.link}" target="_blank" style="color:#22c55e">ğŸ”— Ver link</a>` 
        : ""
      }
    `;

    optionsList.appendChild(li);
  });
}



async function adminReset() {
  if (!confirm("Â¿Reiniciar TODO el sorteo?")) return;

  const users = await db.collection("users").get();
  users.forEach(d => d.ref.delete());

  const options = await db.collection("options").get();
  options.forEach(d => d.ref.delete());

  await db.collection("draws").doc(DRAW_ID).delete();

  alert("âœ… Sorteo reiniciado");
}
  
</script>



</body>
</html>


























