<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>ğŸ„ Amigo NavideÃ±o Marvel</title>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
body {
  font-family: 'Segoe UI', system-ui;
  background: radial-gradient(circle at top, #14532d, #020617);
  color: white;
  padding: 10px;
  max-width: 420px;
  margin: auto;
}
h2{text-align:center}
.card{
  background:rgba(30,41,59,.95);
  padding:15px;
  border-radius:18px;
  margin-bottom:15px
}
button{
  width:100%;
  padding:14px;
  margin-top:10px;
  border-radius:14px;
  border:none;
  background:linear-gradient(135deg,#22c55e,#16a34a);
  color:white;
  font-weight:bold;
  cursor:pointer
}
input,textarea{
  width:100%;
  padding:12px;
  border-radius:12px;
  border:none;
  margin-top:8px
}
ul{list-style:none;padding:0}
li{
  background:#020617;
  padding:12px;
  border-radius:12px;
  margin-bottom:8px
}
.snow{
  position:fixed;
  top:-10px;
  animation:fall linear infinite
}
@keyframes fall{
  to{transform:translateY(110vh)}
}
</style>
</head>

<body>

<script>
for(let i=0;i<35;i++){
  let s=document.createElement("div");
  s.className="snow";
  s.innerText="â„ï¸";
  s.style.left=Math.random()*100+"vw";
  s.style.animationDuration=5+Math.random()*5+"s";
  document.body.appendChild(s);
}
</script>

<h2>ğŸ„ Amigo NavideÃ±o Marvel</h2>

<div class="card">
<input id="userCode" placeholder="CÃ³digo Ãºnico (MARVEL01)"
oninput="this.value=this.value.toUpperCase()">
<button onclick="loadUser()">Ingresar</button>
</div>

<div class="card">
<h3>ğŸ¦¸â€â™‚ï¸ Tu personaje</h3>
<p id="myCharacter">---</p>
<button onclick="assignCharacter()">Asignar personaje</button>

<h3>ğŸ Regalas a</h3>
<p id="giftCharacter">---</p>
<button onclick="drawGift()">Sortear regalo</button>
</div>

<div class="card">
<textarea id="giftOptions"
placeholder="Escribe 3 opciones de regalo"></textarea>
<button onclick="saveOptions()">Guardar opciones</button>
</div>

<div class="card">
<h3>ğŸ€ Opciones de regalo</h3>
<ul id="optionsList"></ul>
</div>

<button id="adminBtn" onclick="adminReset()" style="display:none">
ğŸ” Reiniciar sorteo
</button>

<script>
/* ğŸ”¥ FIREBASE */
firebase.initializeApp({
  apiKey: "AIzaSyBKeNX9UmyrXfj-CxrqMj5ZoOtPI-lvysw",
  authDomain: "amigo-navideno-marvel.firebaseapp.com",
  projectId: "amigo-navideno-marvel"
});
const db = firebase.firestore();

/* ğŸ”‘ VARIABLES */
let currentUser=null;
const DRAW_ID="GLOBAL_DRAW";
const characters=[
  'Iron Man','Capitan America','Thor','Hulk','Viuda Negra','Ojo de HalcÃ³n',
  'Spider-Man','Doctor Strange','Pantera Negra','Bruja Escarlata','Vision',
  'Ant-Man','Wasp','Loki','Capitan Marvel','Deadpool','Thanos','Wolverine'
];

/* ğŸ”€ SORTEO GLOBAL */
function shuffle(a){return a.sort(()=>Math.random()-.5)}

async function createGlobalDraw(){
  const ref=db.collection("draws").doc(DRAW_ID);
  const snap=await ref.get();
  if(snap.exists) return snap.data().map;

  const mix=shuffle([...characters]);
  const map={};
  mix.forEach((c,i)=>map[c]=mix[(i+1)%mix.length]);
  await ref.set({map});
  return map;
}

/* ğŸ‘¤ USUARIO */
function loadUser(){
  const code=userCode.value.trim().toUpperCase();
  if(!code) return alert("Ingresa un cÃ³digo");
  currentUser=code;
  if(code==="ADMIN123") adminBtn.style.display="block";
}

/* ğŸ¦¸ PERSONAJE */
async function assignCharacter(){
  const ref=db.collection("users").doc(currentUser);
  const doc=await ref.get();
  if(doc.exists && doc.data().character){
    myCharacter.innerText=doc.data().character;
    return;
  }
  const used=await db.collection("users").get();
  const taken=used.docs.map(d=>d.data().character).filter(Boolean);
  const free=characters.filter(c=>!taken.includes(c));
  if(!free.length) return alert("No hay personajes disponibles");
  const pick=free[Math.floor(Math.random()*free.length)];
  await ref.set({character:pick},{merge:true});
  myCharacter.innerText=pick;
}

/* ğŸ SORTEAR */
async function drawGift(){
  const ref=db.collection("users").doc(currentUser);
  const doc=await ref.get();
  if(!doc.exists||!doc.data().character)
    return alert("Asigna tu personaje primero");

  if(doc.data().giftTo){
    giftCharacter.innerText=doc.data().giftTo;
    loadOptionsForGift();
    return;
  }

  const map=await createGlobalDraw();
  const giftTo=map[doc.data().character];
  await ref.set({giftTo},{merge:true});
  giftCharacter.innerText=giftTo;
  loadOptionsForGift();
}

/* ğŸ€ GUARDAR OPCIONES */
async function saveOptions(){
  const ref=db.collection("users").doc(currentUser);
  const doc=await ref.get();
  if(!doc.exists) return;

  await db.collection("options").doc(doc.data().character).set({
    text:giftOptions.value
  });
  giftOptions.value="";
  alert("âœ… Opciones guardadas");
}

/* ğŸ‘€ VER OPCIONES SOLO DEL SORTEADO */
async function loadOptionsForGift(){
  optionsList.innerHTML="";
  const doc=await db.collection("users").doc(currentUser).get();
  if(!doc.data().giftTo){
    optionsList.innerHTML="<li>ğŸ AÃºn no has sorteado</li>";
    return;
  }
  const opt=await db.collection("options").doc(doc.data().giftTo).get();
  if(!opt.exists){
    optionsList.innerHTML="<li>â³ AÃºn no han colocado opciones</li>";
    return;
  }
  optionsList.innerHTML=
    `<li><strong>${doc.data().giftTo}</strong><br>${opt.data().text}</li>`;
}

/* ğŸ” ADMIN */
async function adminReset(){
  if(!confirm("Â¿Reiniciar TODO?")) return;
  const c=await db.listCollections();
  for(const col of c){
    const snap=await col.get();
    snap.forEach(d=>d.ref.delete());
  }
  alert("âœ… Sorteo reiniciado");
}
</script>

</body>
</html>










